!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.VueCrontab=n()}(this,function(){"use strict";function t(t,n,e,i){return new(e||(e=Promise))(function(r,s){function o(t){try{a(i.next(t))}catch(t){s(t)}}function u(t){try{a(i.throw(t))}catch(t){s(t)}}function a(t){t.done?r(t.value):new e(function(n){n(t.value)}).then(o,u)}a((i=i.apply(t,n||[])).next())})}function n(t){t.mixin({created:function(){},updated:function(){}}),t.prototype.$crontab=o.getInstance()}class e{constructor(t={}){this.initialize(t)}initialize(t={}){this.results=[],this.max_rec_num=t.max_rec_num||1,this.counter=0}addResult(t,n,e="cron",i=new Date){this.results.length>=this.max_rec_num&&this.deleteFirstResult(),this.counter++;const r={match_date:t,result:n,type:e,finish_date:i};return this.results.push(r)}deleteFirstResult(){return 0===this.results.length?{}:this.results.shift()}getLastResult(){return 0===this.results.length?{}:this.results[this.results.length-1]}getResults(){return this.results}}class i{static stringToObject(t){if("string"==typeof t){let n={};const e=t.split(" ");for(let t in this.settings){const i=this.settings[t].name,r=void 0!==e[t]?e[t]:"*";n[i]=r}return n}return t}static convertDateToObject(t){return{milliseconds:Math.floor(t.getMilliseconds()/this.milliseconds_increments),seconds:t.getSeconds(),minutes:t.getMinutes(),hours:t.getHours(),day:t.getDate(),month:t.getMonth()+1,year:t.getFullYear(),week:t.getDay()}}static fillUnsetDefaultValue(t){let n=Object.assign({},t);for(let e in this.settings){let i=this.settings[e].name;n[i]=void 0===t[i]?this.settings[e].default:t[i]}return n}static isMatch(t,n){const e=this.convertDateToObject(n);let i=null;i="string"==typeof t?this.stringToObject(t):this.fillUnsetDefaultValue(t);for(const t in this.settings){const n=this.settings[t].name,r=i[n],s=e[n],o=this.isMatchPart(r,s);if(!0!==o)return!1}return!0}static isMatchPart(t,n){if("*"===t)return!0;const e=t.split(",");if(e.length>1){if(e.indexOf("")>=0)throw new Error("comma format error.");for(const t in e){const i=e[t],r=this.isMatchPartOne(i,n);if(r)return!0}return!1}return this.isMatchPartOne(t,n)}static isMatchPartOne(t,n){const e=this.isMatchSlash(t,n);if(0!==e)return 1===e;const i=this.isMatchHyphen(t,n);if(0!==i)return 1===i;if(isNaN(Number(t)))throw new Error("number format error.");return Number(t)===n}static isMatchSlash(t,n){const e=t.split("/");if(2===e.length){const t=Number(e[1]);return isNaN(t)||isNaN(n)||0===t?-1:n%t==0?1:-1}if(e.length>2)throw new Error("slash format error.");return 0}static isMatchHyphen(t,n){const e=t.split("-");if(2===e.length){const t=""===e[0]?null:Number(e[0]),i=""===e[1]?null:Number(e[1]);return(isNaN(t)||null===t)&&n<=i?1:(isNaN(i)||null===i)&&n>=t?1:(!isNaN(t)&&null!==t||!isNaN(i)&&null!==i)&&t<=n&&n<=i?1:-1}if(e.length>2)throw new Error("hyphen format error.");return 0}static validateInterval(t){let n=null;if("string"==typeof t){if(""===t)return!1;n=this.stringToObject(t)}else{if(0===Object.keys(t).length)return!1;n=t}n=this.fillUnsetDefaultValue(n);for(let t in this.settings){let e=this.settings[t].name,i=n[e],r=this.validateIntervalPart(i,this.settings[t].validate);if(!r)return!1}return!0}static validateIntervalPart(t,n={}){if(""===t)return!1;const e=t.split(",");if(e.length>1)for(let t in e){let i=e[t];if(!this.checkIntervalPiece(i,n))return!1}else if(!this.checkIntervalPiece(t,n))return!1;return!0}static checkIntervalPiece(t,n={}){if("*"===t)return!0;let e=this.checkSlash(t);if(0!==e)return 1===e;let i=this.checkHyphen(t,n);return 0!==i?1===i:!!this.checkNum(t)&&this.checkRange(t,n)}static checkSlash(t){const n=t.split("/");return 1===n.length?0:n.length>=3?-1:""!==n[0]?-1:isNaN(Number(n[1]))?-1:1}static checkHyphen(t,n={}){const e=t.split("-");if(1===e.length)return 0;if(e.length>=3)return-1;let i=Number(e[0]),r=Number(e[1]);return""===e[0]?isNaN(r)?-1:this.checkRange(e[1],n)?1:-1:""===e[1]?isNaN(i)?-1:this.checkRange(e[0],n)?1:-1:isNaN(i)||isNaN(r)?-1:this.checkRange(e[0],n)&&this.checkRange(e[1],n)?i>r?-1:1:-1}static checkNum(t){return""!==t&&!isNaN(Number(t))}static checkRange(t,n={}){let e=Number(t);return void 0!==n.start&&void 0!==n.end?n.start<=e&&e<=n.end:void 0!==n.start?n.start<=e:void 0===n.end||e<=n.end}}i.settings=[{name:"milliseconds",validate:{start:0,end:9},default:"*"},{name:"seconds",validate:{start:0,end:59},default:"*"},{name:"minutes",validate:{start:0,end:59},default:"*"},{name:"hours",validate:{start:0,end:23},default:"*"},{name:"day",validate:{start:1,end:31},default:"*"},{name:"month",validate:{start:1,end:12},default:"*"},{name:"year",validate:{start:0},default:"*"},{name:"week",validate:{start:0,end:6},default:"*"}],i.milliseconds_increments=100;class r{constructor(t={}){this.initialize(t),this.reflectSetting(t)}initialize(t={}){this.setting=t,this.record=[],this.counter=0,this.last_check=null,this.last_run=void 0,this.state={status:Number(t.status)||1,execution:0,sync:Number(t.sync)||0},this.jobs=[],this.intervals=[],this.conditions=[]}reflectSetting(t){let n=r.validate(t);if(1!==n)switch(n){case-1:throw new Error("name format error.");case-2:throw new Error("job format error.");case-3:throw new Error("interval format error.");case-5:throw new Error("condition format error.");default:throw new Error("unexpected error.")}else{if(-1===this.addJob(t.job,t))throw new Error("add job error.");if(-1===this.addInterval(t.interval))throw new Error("add interval error.");if(t.condition&&-1===this.addCondition(t.condition))throw new Error("add condition error.")}}addJob(t,n){if(Array.isArray(t)){for(let i in t)this.jobs.push(t[i]),this.record.push(new e(n));return t.length}return"function"==typeof t?(this.jobs.push(t),this.record.push(new e(n)),1):-1}addInterval(t){const n=["string","object"];if(Array.isArray(t)){for(let n in t){let e=t[n];if(!i.validateInterval(e))return-1;let r=i.fillUnsetDefaultValue(i.stringToObject(e));this.intervals.push(r)}return t.length}if(n.indexOf(typeof t)>=0){if(!i.validateInterval(t))return-1;let n=i.fillUnsetDefaultValue(i.stringToObject(t));return this.intervals.push(n),1}return-1}addCondition(t){if(Array.isArray(t)){for(let n in t)this.conditions.push(t[n]);return t.length}return"function"==typeof t?(this.conditions.push(t),1):-1}execute(n){return t(this,void 0,void 0,function*(){this.last_check=n;let t=1;if(1!==this.state.status)t=-1;else{for(let e in this.intervals){let r=this.intervals[e];if(!i.isMatch(r,n)){t=0;break}}for(let n in this.conditions){let e=this.conditions[n];if(!e()){t=-2;break}}1===t&&(t=yield this.run(n))}return{code:t,date:n}})}manualExecute(){return t(this,void 0,void 0,function*(){const t=new Date;return{code:yield this.run(t,"manual"),date:t}})}run(n=new Date,e="cron"){return t(this,void 0,void 0,function*(){function i(){return new Promise((i,a)=>{setTimeout(function(){return t(this,void 0,void 0,function*(){let t=yield r.jobs[s](u);r.setResult(o,n,t,e);i()})},0)}).catch(t=>void 0)}let r=this,s=null,o=null,u=null;for(s in this.jobs)try{o=Number(s),u=this.getJobArguments(o,n),1===r.setting.sync?yield i():i()}catch(t){}return this.last_run=n,1})}start(){this.state.status=1}stop(){this.state.status=0}static validate(t){if(0===Object.keys(t).length&&t.constructor===Object)return-4;let n=t.name;return"string"!=typeof n||""===n?-1:this.validateJobs(t.job)?this.validateIntervals(t.interval)?t.condition&&!this.validateCondition(t.condition)?-5:1:-3:-2}static validateJobs(t){const n=["function"];if(void 0===t)return!1;if(Array.isArray(t)){if(0===t.length)return!1;for(let e in t)if(-1===n.indexOf(typeof t[e]))return!1}else if(-1===n.indexOf(typeof t))return!1;return!0}static validateIntervals(t){const n=["string","object"];if(void 0!==t){if(Array.isArray(t)){if(0===t.length)return!1;for(let e in t){if(-1===n.indexOf(typeof t[e]))return!1;if(!i.validateInterval(t[e]))return!1}}else{if(-1===n.indexOf(typeof t))return!1;if(!i.validateInterval(t))return!1}return!0}return!1}static validateCondition(t){const n=["function"];if(void 0!==t)if(Array.isArray(t)){if(0===t.length)return!0;for(let e in t)if(-1===n.indexOf(typeof t[e]))return!1}else if(-1===n.indexOf(typeof t))return!1;return!0}getJobArguments(t=0,n){if(0<=t&&t<this.record.length){const e=this.record[t].getLastResult();return{exec_date:n,last_run:this.last_run,counter:this.record[t].counter,last_result:e.result,type:e.type}}return{}}setResult(t,n,e,i="cron",r=new Date){return 0<=t&&t<this.record.length&&(this.last_run=n,this.counter++,this.record[t].addResult(n,e,i,r),!0)}getLatestResult(t=0){return 0<=t&&t<this.record.length?this.record[t].getLastResult():{}}getState(){return this.state}}class s{constructor(t={}){this.setOption(t)}setOption(t){this.interval=void 0!==t.interval?t.interval:1e3,this.auto_start=void 0===t.auto_start||t.auto_start}getInterval(){return this.interval}}class o{constructor(t){if(this.install=n,t!=o.getInstance)throw o._instance?new Error("vuecrontab instance already created."):new Error("instance create error.");this.initialize()}initialize(t={}){this.jobs={},this.state={},this.interval_id=null,this.state={},this.setOption(t)}setOption(t){this.option=new s(t)}getOption(){return this.option}startCrontab(){if(null!==this.interval_id)return 2;if(0===Object.keys(this.jobs).length)return 0;let t=0;do{let n=new Date;t=n.getMilliseconds()}while(!(40<=t&&t<=60));let n=this;return this.interval_id=setInterval(function(){let t=new Date;for(const e in n.jobs){let i=n.jobs[e];i.execute(t)}},this.option.getInterval()),1}stopCrontab(){clearInterval(this.interval_id)}enableJob(t){return null!==this.getJob(t)&&(this.jobs[t].start(),!0)}disableJob(t){return null!==this.getJob(t)&&(this.jobs[t].stop(),!0)}addJob(t){let n=0;if(Array.isArray(t))for(let e in t){let i=t[e],s=r.validate(i);if(1===s){let t=i.name;if(this.isDuplicateJob(t))continue;let e=new r(i);this.jobs[t]=e,n++}}else{if("object"!=typeof t)return 0;{let e=r.validate(t);if(1===e){let e=t.name;if(this.isDuplicateJob(e))return 0;let i=new r(t);this.jobs[e]=i,n=1}}}return Object.keys(this.jobs).length>0&&this.option.auto_start&&this.startCrontab(),n}isDuplicateJob(t){return null!==this.getJob(t)}deleteJob(t){return null!==this.getJob(t)&&(delete this.jobs[t],0===Object.keys(this.jobs).length&&this.stopCrontab(),!0)}execJob(n){return t(this,void 0,void 0,function*(){const t=new Date;if(null!==this.getJob(n)){let t=yield this.jobs[n].manualExecute();return t}return{code:-2,date:t}})}getJob(t){return this.jobs[t]||null}static getInstance(){return this._instance||(this._instance=new o(o.getInstance)),this._instance}}return o.getInstance()});
